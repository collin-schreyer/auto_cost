<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Area Database Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 0 10px;
        }
        
        .status-online {
            background: #2ecc71;
            color: white;
        }
        
        .status-offline {
            background: #e74c3c;
            color: white;
        }
        
        .status-loading {
            background: #f39c12;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.7);
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #2c3e50;
        }
        
        .tab:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .region-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .region-card:hover {
            transform: translateY(-5px);
        }
        
        .region-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .region-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            text-transform: capitalize;
        }
        
        .booth-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .booth-occupied {
            background: #e74c3c;
            color: white;
        }
        
        .booth-empty {
            background: #2ecc71;
            color: white;
        }
        
        /* NEW: Rack Tracking Styles */
        .rack-tracking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .camera-zone {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .camera-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            text-transform: capitalize;
        }
        
        .rack-count {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .zone-layout {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .zone-slot {
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .zone-slot.occupied {
            border: 2px solid #3498db;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .zone-slot.moving {
            border: 2px solid #e74c3c;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .zone-slot.transition {
            border: 2px solid #f39c12;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .zone-name {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .rack-info {
            text-align: center;
        }
        
        .rack-id {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .rack-global-id {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .rack-status {
            font-size: 0.6rem;
            margin-top: 3px;
        }
        
        .movement-indicators {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .movement-arrow {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .movement-arrow.to-powder {
            background: #9b59b6;
        }
        
        .movement-arrow.to-general {
            background: #27ae60;
        }
        
        .global-racks-summary {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .global-racks-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .global-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .global-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .global-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .global-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .recent-movements {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .movement-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .movement-item:last-child {
            border-bottom: none;
        }
        
        .movement-description {
            flex: 1;
        }
        
        .movement-time {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .review-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        
        .review-btn:hover {
            background: #2980b9;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .data-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-table tr:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .timestamp {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .action-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .action-hanging {
            background: #f39c12;
            color: white;
        }
        
        .action-removing {
            background: #e74c3c;
            color: white;
        }
        
        .action-pushing {
            background: #9b59b6;
            color: white;
        }
        
        .moving-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .moving-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .moving-true .moving-dot {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }
        
        .moving-false .moving-dot {
            background: #2ecc71;
        }
        
        .camera-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            transition: background 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .camera-btn:hover {
            background: #2980b9;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .no-data {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-container {
            text-align: center;
        }
        
        .review-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .image-title {
            margin-bottom: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .single-image {
            text-align: center;
            margin-top: 20px;
        }
        
        .single-image .review-image {
            max-width: 80%;
            max-height: 70vh;
        }
        
        /* NEW: Explanation display styles */
        .current-status-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .current-image-section {
            text-align: center;
        }
        
        .explanations-section {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .explanations-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .explanations-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .explanation-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .explanation-item.latest {
            border-left: 4px solid #3498db;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        }
        
        .explanation-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .explanation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .explanation-time {
            font-size: 0.8rem;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
        }
        
        .explanation-type {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .explanation-confidence {
            background: #2ecc71;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .explanation-text {
            color: #2c3e50;
            line-height: 1.5;
            margin-bottom: 10px;
            font-size: 0.95rem;
            background: rgba(52, 152, 219, 0.05);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }
        
        .explanation-details {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .detection-badge {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .detection-badge.forklift {
            background: #f39c12;
            color: white;
        }
        
        .detection-badge.manual {
            background: #27ae60;
            color: white;
        }
        
        .detection-badge.people {
            background: #8e44ad;
            color: white;
        }
        
        .detection-badge.zone {
            background: #34495e;
            color: white;
        }
        
        .detection-badge.action {
            background: #e67e22;
            color: white;
        }
        
        /* Current status info styles */
        .current-status-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .current-status-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }
        
        .status-label {
            font-weight: bold;
            color: #34495e;
            font-size: 0.85rem;
        }
        
        .status-value {
            font-size: 0.85rem;
        }
        
        .status-value.occupied {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .status-value.empty {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-value.timestamp {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #7f8c8d;
        }
        
        @media (max-width: 768px) {
            .current-status-content {
                grid-template-columns: 1fr;
            }
            
            .explanation-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Burst content styles */
        .rack-burst-content,
        .hanging-burst-content {
            padding: 20px;
        }
        
        .burst-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .burst-info h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .burst-info p {
            margin: 5px 0;
            color: #34495e;
            font-size: 0.9rem;
        }
        
        .burst-instructions {
            margin-top: 20px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .burst-instructions p {
            margin: 8px 0;
            font-size: 0.9rem;
            color: #2c3e50;
        }
        
        .image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
            background: #ecf0f1;
            color: #7f8c8d;
            border-radius: 8px;
            font-style: italic;
        }
        
        /* Rack tracking specific controls */
        .rack-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .rack-filter {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background: white;
            font-size: 0.9rem;
        }
        
        .rack-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .legend-stationary {
            background: #3498db;
        }
        
        .legend-moving {
            background: #e74c3c;
        }
        
        .legend-transition {
            background: #f39c12;
        }
        
        .legend-empty {
            background: #ecf0f1;
            border: 2px dashed #bdc3c7;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè≠ Production Area Database Dashboard</h1>
        <div>
            <span class="status-indicator" id="connection-status">üîÑ Connecting...</span>
            <span class="status-indicator" id="last-update">Last Update: Never</span>
        </div>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('booth-status')">Booth Status</button>
            <button class="tab" onclick="showTab('rack-tracking')">üöú Rack Tracking</button>
            <button class="tab" onclick="showTab('rack-positions')">Rack Positions</button>
            <button class="tab" onclick="showTab('rack-events')">Rack Events</button>
            <button class="tab" onclick="showTab('history')">History</button>
        </div>
        
        <div class="tab-content">
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>
            
            <!-- Booth Status Tab -->
            <div id="booth-status" class="tab-panel">
                <div class="region-grid" id="booth-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading booth data...
                    </div>
                </div>
            </div>
            
            <!-- NEW: Rack Tracking Tab -->
            <div id="rack-tracking" class="tab-panel" style="display: none;">
                <!-- Global Rack Summary -->
                <div class="global-racks-summary">
                    <div class="global-racks-header">
                        <h2>üåê Global Rack Registry</h2>
                    </div>
                    
                    <div class="global-stats">
                        <div class="global-stat">
                            <div class="global-stat-value" id="total-racks">-</div>
                            <div class="global-stat-label">Total Racks</div>
                        </div>
                        <div class="global-stat">
                            <div class="global-stat-value" id="active-racks">-</div>
                            <div class="global-stat-label">Active</div>
                        </div>
                        <div class="global-stat">
                            <div class="global-stat-value" id="moving-racks">-</div>
                            <div class="global-stat-label">Moving</div>
                        </div>
                        <div class="global-stat">
                            <div class="global-stat-value" id="in-transit-racks">-</div>
                            <div class="global-stat-label">In Transit</div>
                        </div>
                    </div>
                    
                    <div class="recent-movements">
                        <h3>üìã Recent Movements</h3>
                        <div id="recent-movements-list">
                            <div class="loading">Loading movements...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Rack Controls -->
                <div class="rack-controls">
                    <select class="rack-filter" id="rack-status-filter">
                        <option value="all">All Racks</option>
                        <option value="active">Active Only</option>
                        <option value="moving">Moving Only</option>
                        <option value="missing">Missing Racks</option>
                    </select>
                    
                    <select class="rack-filter" id="camera-filter">
                        <option value="all">All Cameras</option>
                        <option value="general_labor">General Labor</option>
                        <option value="powder_booth">Powder Booth</option>
                        <option value="in_transit">In Transit</option>
                    </select>
                    
                    <button class="refresh-btn" onclick="refreshRackData()">üîÑ Refresh Racks</button>
                </div>
                
                <!-- Legend -->
                <div class="rack-legend">
                    <div class="legend-item">
                        <div class="legend-color legend-stationary"></div>
                        <span>Stationary</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-moving"></div>
                        <span>Moving</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-transition"></div>
                        <span>In Transition</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-empty"></div>
                        <span>Empty Zone</span>
                    </div>
                </div>
                
                <!-- Camera Zone Layout -->
                <div class="rack-tracking-grid">
                    <!-- General Labor Camera -->
                    <div class="camera-zone">
                        <div class="camera-header">
                            <div class="camera-name">üè≠ General Labor</div>
                            <div class="rack-count" id="gl-rack-count">0 racks</div>
                        </div>
                        
                        <div class="zone-layout" id="general-labor-zones">
                            <div class="zone-slot" data-zone="left_side">
                                <div class="zone-name">Left Side</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                            <div class="zone-slot" data-zone="center_left">
                                <div class="zone-name">Center Left</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                            <div class="zone-slot" data-zone="center_right">
                                <div class="zone-name">Center Right</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                            <div class="zone-slot" data-zone="right_side">
                                <div class="zone-name">Right Side</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="movement-indicators">
                            <div class="movement-arrow to-powder" id="gl-to-pb-arrow" style="display: none;">
                                ‚Üí Powder Booth
                            </div>
                        </div>
                    </div>
                    
                    <!-- Powder Booth Camera -->
                    <div class="camera-zone">
                        <div class="camera-header">
                            <div class="camera-name">üé® Powder Booth</div>
                            <div class="rack-count" id="pb-rack-count">0 racks</div>
                        </div>
                        
                        <div class="zone-layout" id="powder-booth-zones">
                            <div class="zone-slot" data-zone="entrance">
                                <div class="zone-name">Entrance</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                            <div class="zone-slot" data-zone="center">
                                <div class="zone-name">Center</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                            <div class="zone-slot" data-zone="back_wall" style="grid-column: span 2;">
                                <div class="zone-name">Back Wall</div>
                                <div class="rack-info">
                                    <div class="no-data">Empty</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="movement-indicators">
                            <div class="movement-arrow to-general" id="pb-to-gl-arrow" style="display: none;">
                                ‚Üê General Labor
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Global Racks Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Global ID</th>
                            <th>Current Location</th>
                            <th>Zone</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="global-racks-body">
                        <tr><td colspan="6" class="loading">Loading global racks...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Rack Positions Tab -->
            <div id="rack-positions" class="tab-panel" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Camera</th>
                            <th>Rack ID</th>
                            <th>Global ID</th>
                            <th>Zone</th>
                            <th>Status</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody id="rack-positions-body">
                        <tr><td colspan="7" class="loading">Loading rack positions...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Rack Events Tab -->
            <div id="rack-events" class="tab-panel" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Camera</th>
                            <th>Rack ID</th>
                            <th>People</th>
                            <th>Action</th>
                            <th>Confidence</th>
                            <th>Zone</th>
                            <th>Review</th>
                        </tr>
                    </thead>
                    <tbody id="rack-events-body">
                        <tr><td colspan="8" class="loading">Loading rack events...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- History Tab -->
            <div id="history" class="tab-panel" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Region</th>
                            <th>State</th>
                            <th>Duration</th>
                            <th>Door Status</th>
                            <th>Person Detected</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <tr><td colspan="6" class="loading">Loading history...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Image Review Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modal-title">Image Review</h2>
            <div id="modal-images"></div>
        </div>
    </div>
    
    <script>
        // Global variables to track state
        let currentGlobalRacks = [];
        let currentMovements = [];
        let refreshInProgress = false;

        // API endpoints for rack tracking
        async function fetchBoothStatus() {
            const response = await fetch('/api/booth-status');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        async function fetchRackPositions() {
            const response = await fetch('/api/rack-positions');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        async function fetchRackEvents() {
            const response = await fetch('/api/rack-events');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        async function fetchHistory() {
            const response = await fetch('/history');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        async function fetchGlobalRacks() {
            console.log('Fetching global racks...');
            const response = await fetch('/api/global-racks');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            console.log(`Fetched ${data.length} global racks`);
            return data;
        }
        
        async function fetchRackMovements() {
            console.log('Fetching rack movements...');
            const response = await fetch('/api/rack-movements?hours=4');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            console.log(`Fetched ${data.length} movements`);
            return data;
        }
        
        async function fetchRackSummary() {
            const response = await fetch('/api/rack-summary');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        function showTab(tabName) {
            console.log(`Switching to tab: ${tabName}`);
            
            // Hide all tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab panel
            const selectedPanel = document.getElementById(tabName);
            if (selectedPanel) {
                selectedPanel.style.display = 'block';
            }
            
            // Add active class to selected tab
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // If switching to rack tracking, refresh rack data
            if (tabName === 'rack-tracking') {
                console.log('Switching to rack tracking tab - refreshing data...');
                setTimeout(() => {
                    refreshRackData();
                }, 100); // Small delay to ensure DOM is ready
            }
        }
        
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }
        
        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
        
        async function fetchBoothAnalysis(region) {
            // Try to get the most recent booth analysis/detection for this region
            const response = await fetch(`/api/booth-analysis/${region}?limit=3`);
            if (!response.ok) {
                // Fallback: try to get any recent events for this camera
                const fallbackResponse = await fetch(`/api/events-with-explanations?camera_id=${region}&limit=3`);
                if (fallbackResponse.ok) {
                    return await fallbackResponse.json();
                }
                throw new Error(`HTTP ${response.status}`);
            }
            return await response.json();
        }

        async function showCurrentImage(region) {
            const modal = document.getElementById('imageModal');
            const title = document.getElementById('modal-title');
            const imagesDiv = document.getElementById('modal-images');
            
            title.textContent = `Current Status - ${region.replace('_', ' ').toUpperCase()}`;
            
            // Start with loading state
            imagesDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading current status and recent analysis...
                </div>
            `;
            
            modal.style.display = 'block';
            
            try {
                // Try multiple approaches to get recent analysis
                let explanations = [];
                
                try {
                    // First try: booth-specific analysis
                    explanations = await fetchBoothAnalysis(region);
                } catch (error) {
                    console.log('Booth analysis not available, trying rack events...');
                    
                    try {
                        // Second try: recent rack events for this camera
                        const response = await fetch(`/api/events-with-explanations?camera_id=${region}&limit=3`);
                        if (response.ok) {
                            explanations = await response.json();
                        }
                    } catch (error2) {
                        console.log('Rack events not available, trying general events...');
                        
                        try {
                            // Third try: any recent events from this camera
                            const response = await fetch(`/api/rack-events/${region}?limit=5`);
                            if (response.ok) {
                                const events = await response.json();
                                explanations = events.filter(e => e.explanation && e.explanation !== '');
                            }
                        } catch (error3) {
                            console.log('No events available');
                        }
                    }
                }
                
                // Get booth status for additional context
                let boothStatus = null;
                try {
                    const statusResponse = await fetch('/api/booth-status');
                    if (statusResponse.ok) {
                        const allBooths = await statusResponse.json();
                        boothStatus = allBooths.find(b => b.region === region);
                    }
                } catch (error) {
                    console.log('Could not fetch booth status');
                }
                
                // Build the modal content with image and explanations
                let explanationHtml = '';
                let statusHtml = '';
                
                // Add current booth status if available
                if (boothStatus) {
                    statusHtml = `
                        <div class="current-status-info">
                            <h4>üìä Current Status</h4>
                            <div class="status-grid">
                                <div class="status-item">
                                    <span class="status-label">Booth:</span>
                                    <span class="status-value ${boothStatus.in_use ? 'occupied' : 'empty'}">
                                        ${boothStatus.in_use ? 'üî¥ OCCUPIED' : 'üü¢ EMPTY'}
                                    </span>
                                </div>
                                ${boothStatus.person_detected !== null ? `
                                <div class="status-item">
                                    <span class="status-label">Person:</span>
                                    <span class="status-value">${boothStatus.person_detected ? 'üë§ Detected' : 'üëª None'}</span>
                                </div>
                                ` : ''}
                                ${boothStatus.door_closed !== null ? `
                                <div class="status-item">
                                    <span class="status-label">Door:</span>
                                    <span class="status-value">${boothStatus.door_closed ? 'üö™üîí Closed' : 'üö™üìñ Open'}</span>
                                </div>
                                ` : ''}
                                <div class="status-item">
                                    <span class="status-label">Updated:</span>
                                    <span class="status-value timestamp">${formatTimestamp(boothStatus.last_updated)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                if (explanations && explanations.length > 0) {
                    explanationHtml = `
                        <div class="explanations-section">
                            <h3>ü§ñ Recent AI Analysis</h3>
                            <div class="explanations-list">
                                ${explanations.slice(0, 3).map((event, index) => {
                                    // Handle different event types
                                    const operationType = event.operation_type || 'detection';
                                    const action = event.action || 'activity';
                                    const explanation = event.explanation || 'Analysis completed';
                                    
                                    return `
                                        <div class="explanation-item ${index === 0 ? 'latest' : ''}">
                                            <div class="explanation-header">
                                                <span class="explanation-time">${formatTimestamp(event.timestamp)}</span>
                                                <span class="explanation-type">${operationType}</span>
                                                ${event.confidence ? `<span class="explanation-confidence">${(event.confidence * 100).toFixed(0)}%</span>` : ''}
                                            </div>
                                            <div class="explanation-text">
                                                ${explanation}
                                            </div>
                                            <div class="explanation-details">
                                                ${event.forklift_detected ? '<span class="detection-badge forklift">üöú Forklift</span>' : ''}
                                                ${event.manual_detected ? '<span class="detection-badge manual">üë§ Manual</span>' : ''}
                                                ${event.people_count > 0 ? `<span class="detection-badge people">${event.people_count} Person${event.people_count > 1 ? 's' : ''}</span>` : ''}
                                                ${event.zone ? `<span class="detection-badge zone">üìç ${event.zone}</span>` : ''}
                                                ${action && action !== 'activity' ? `<span class="detection-badge action">üîß ${action}</span>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    explanationHtml = `
                        <div class="explanations-section">
                            <h3>ü§ñ AI Analysis</h3>
                            <div class="no-data">
                                No recent AI analysis available for this camera.<br>
                                <small>The system may be processing or this camera may not have recent activity.</small>
                            </div>
                        </div>
                    `;
                }
                
                imagesDiv.innerHTML = `
                    <div class="current-status-content">
                        <div class="current-image-section">
                            <div class="image-title">üì∑ Latest Camera View</div>
                            <img src="/api/current-image/${region}?t=${Date.now()}" class="review-image" 
                                 alt="Current ${region} status" 
                                 onerror="this.alt='Image not available'; this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display:none; color:#666; font-style:italic; padding: 20px;">
                                üì∑ Image not available<br>
                                <small>Camera may be offline or image not ready</small>
                            </div>
                            ${statusHtml}
                        </div>
                        ${explanationHtml}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading current status:', error);
                
                // Fallback to just showing the image with basic info
                imagesDiv.innerHTML = `
                    <div class="current-status-content">
                        <div class="current-image-section">
                            <div class="image-title">üì∑ Latest Camera View</div>
                            <img src="/api/current-image/${region}?t=${Date.now()}" class="review-image" 
                                 alt="Current ${region} status" 
                                 onerror="this.alt='Image not available'; this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display:none; color:#666; font-style:italic; padding: 20px;">üì∑ Image not available</div>
                        </div>
                        <div class="explanations-section">
                            <h3>ü§ñ Status</h3>
                            <div class="no-data">
                                Unable to load recent analysis.<br>
                                <small>Error: ${error.message}</small><br><br>
                                <button onclick="showCurrentImage('${region}')" class="refresh-btn">üîÑ Try Again</button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function showRackBurst(timestamp, camera, rackId) {
            const modal = document.getElementById('imageModal');
            const title = document.getElementById('modal-title');
            const imagesDiv = document.getElementById('modal-images');
            
            // Format the timestamp for the API call (convert ISO to safe filename format)
            const safeTimestamp = timestamp.replace(/:/g, '-').replace('T', '_').replace('Z', '');
            
            title.textContent = `Rack Movement Analysis - ${camera.replace('_', ' ').toUpperCase()} - ${rackId} - ${formatTimestamp(timestamp)}`;
            
            // Start with loading state
            imagesDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading rack movement frames...
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Build the 4-frame burst display
            imagesDiv.innerHTML = `
                <div class="rack-burst-content">
                    <div class="burst-info">
                        <h3>üîç 4-Frame Movement Analysis</h3>
                        <p>Sequence captured: ${formatTimestamp(timestamp)}</p>
                        <p>Camera: ${camera.replace('_', ' ').toUpperCase()} | Rack: ${rackId}</p>
                    </div>
                    
                    <div class="image-grid">
                        <div class="image-container">
                            <div class="image-title">Frame 1 - Initial</div>
                            <img src="/api/rack-burst/${camera}/${safeTimestamp}/1" class="review-image" 
                                 alt="Frame 1" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 1 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 1...</div>
                        </div>
                        <div class="image-container">
                            <div class="image-title">Frame 2 - Movement</div>
                            <img src="/api/rack-burst/${camera}/${safeTimestamp}/2" class="review-image" 
                                 alt="Frame 2" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 2 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 2...</div>
                        </div>
                        <div class="image-container">
                            <div class="image-title">Frame 3 - Transition</div>
                            <img src="/api/rack-burst/${camera}/${safeTimestamp}/3" class="review-image" 
                                 alt="Frame 3" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 3 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 3...</div>
                        </div>
                        <div class="image-container">
                            <div class="image-title">Frame 4 - Final</div>
                            <img src="/api/rack-burst/${camera}/${safeTimestamp}/4" class="review-image" 
                                 alt="Frame 4" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 4 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 4...</div>
                        </div>
                    </div>
                    
                    <div class="burst-instructions">
                        <p><strong>How to analyze:</strong> Look for rack position changes between frames to identify movement patterns.</p>
                        <p><em>Note: If burst images are not available, current camera view is shown as fallback.</em></p>
                    </div>
                </div>
            `;
        }
        
        function showHangingBurst(timestamp, camera) {
            const modal = document.getElementById('imageModal');
            const title = document.getElementById('modal-title');
            const imagesDiv = document.getElementById('modal-images');
            
            // Format the timestamp for the API call
            const safeTimestamp = timestamp.replace(/:/g, '-').replace('T', '_').replace('Z', '');
            
            title.textContent = `Parts Hanging Analysis - ${camera.replace('_', ' ').toUpperCase()} - ${formatTimestamp(timestamp)}`;
            
            // Start with loading state
            imagesDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Loading hanging activity frames...
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Build the 4-frame burst display for hanging parts
            imagesDiv.innerHTML = `
                <div class="hanging-burst-content">
                    <div class="burst-info">
                        <h3>üîß 4-Frame Hanging Analysis</h3>
                        <p>Activity captured: ${formatTimestamp(timestamp)}</p>
                        <p>Camera: ${camera.replace('_', ' ').toUpperCase()}</p>
                    </div>
                    
                    <div class="image-grid">
                        <div class="image-container">
                            <div class="image-title">Frame 1 - Approach</div>
                            <img src="/api/hanging-burst/${camera}/${safeTimestamp}/1" class="review-image" 
                                 alt="Frame 1" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 1 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 1...</div>
                        </div>
                        <div class="image-container">
                            <div class="image-title">Frame 2 - Positioning</div>
                            <img src="/api/hanging-burst/${camera}/${safeTimestamp}/2" class="review-image" 
                                 alt="Frame 2" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 2 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 2...</div>
                        </div>
                        <div class="image-container">
                            <div class="image-title">Frame 3 - Action</div>
                            <img src="/api/hanging-burst/${camera}/${safeTimestamp}/3" class="review-image" 
                                 alt="Frame 3" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 3 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 3...</div>
                        </div>
                        <div class="image-container">
                            <div class="image-title">Frame 4 - Completion</div>
                            <img src="/api/hanging-burst/${camera}/${safeTimestamp}/4" class="review-image" 
                                 alt="Frame 4" 
                                 onerror="this.src='/api/current-image/${camera}'; this.alt='Frame 4 - using current image';"
                                 onload="this.nextElementSibling.style.display='none';">
                            <div class="image-placeholder">üì∑ Loading frame 4...</div>
                        </div>
                    </div>
                    
                    <div class="burst-instructions">
                        <p><strong>How to analyze:</strong> Follow the sequence to see parts being positioned and hung on racks.</p>
                        <p><em>Note: If burst images are not available, current camera view is shown as fallback.</em></p>
                    </div>
                </div>
            `;
        }
        
        // FIXED: Enhanced rack tracking visualization functions
        function updateRackZones(globalRacks, movements) {
            console.log(`Updating rack zones with ${globalRacks.length} racks and ${movements.length} movements`);
            
            try {
                // Clear all zones first
                clearAllZones();
                
                // Initialize racks by camera structure
                const racksByCamera = {
                    'general_labor': {},
                    'powder_booth': {}
                };
                
                let totalRacks = 0;
                let activeRacks = 0;
                let movingRacks = 0;
                let inTransitRacks = 0;
                
                // Process each global rack
                globalRacks.forEach(rack => {
                    totalRacks++;
                    console.log(`Processing rack: ${rack.rack_id}, status: ${rack.status}, camera: ${rack.current_camera}, zone: ${rack.current_zone}`);
                    
                    if (rack.status === 'active') {
                        activeRacks++;
                        
                        const camera = rack.current_camera;
                        const zone = rack.current_zone;
                        
                        if (camera === 'in_transit') {
                            inTransitRacks++;
                            console.log(`Rack ${rack.rack_id} is in transit`);
                        } else if (camera && zone && (camera === 'general_labor' || camera === 'powder_booth')) {
                            // Ensure the zone array exists
                            if (!racksByCamera[camera][zone]) {
                                racksByCamera[camera][zone] = [];
                            }
                            racksByCamera[camera][zone].push(rack);
                            console.log(`Placed ${rack.rack_id} in ${camera}/${zone}`);
                        } else {
                            console.warn(`Rack ${rack.rack_id} has invalid camera/zone: ${camera}/${zone}`);
                        }
                    } else {
                        console.log(`Rack ${rack.rack_id} is not active (status: ${rack.status})`);
                    }
                });
                
                // Check for recent movements to determine which racks are moving
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const recentMovements = movements.filter(m => {
                    const moveTime = new Date(m.movement_timestamp);
                    return moveTime > fiveMinutesAgo;
                });
                
                const recentlyMovedRacks = new Set(recentMovements.map(m => m.global_rack_id));
                console.log(`Found ${recentlyMovedRacks.size} recently moved racks:`, [...recentlyMovedRacks]);
                
                // Update zone displays for each camera
                updateCameraZones('general_labor', ['left_side', 'center_left', 'center_right', 'right_side'], racksByCamera, recentlyMovedRacks);
                updateCameraZones('powder_booth', ['entrance', 'center', 'back_wall'], racksByCamera, recentlyMovedRacks);
                
                // Count moving racks (recently moved but not in transit)
                movingRacks = [...recentlyMovedRacks].filter(rackId => {
                    const rack = globalRacks.find(r => r.rack_id === rackId);
                    return rack && rack.current_camera !== 'in_transit';
                }).length;
                
                // Update global stats
                updateGlobalStats(totalRacks, activeRacks, movingRacks, inTransitRacks);
                
                // Update movement arrows
                updateMovementArrows(recentMovements);
                
                console.log(`Zone update complete: ${totalRacks} total, ${activeRacks} active, ${movingRacks} moving, ${inTransitRacks} in transit`);
                
            } catch (error) {
                console.error('Error updating rack zones:', error);
            }
        }
        
        // FIXED: Helper function to update zones for a specific camera
        function updateCameraZones(camera, zones, racksByCamera, recentlyMovedRacks) {
            console.log(`Updating zones for ${camera}:`, zones);
            
            zones.forEach(zone => {
                const zoneElement = document.querySelector(`#${camera.replace('_', '-')}-zones .zone-slot[data-zone="${zone}"]`);
                if (!zoneElement) {
                    console.warn(`Zone element not found: ${camera}/${zone}`);
                    return;
                }
                
                const racksInZone = racksByCamera[camera][zone] || [];
                console.log(`Zone ${camera}/${zone} has ${racksInZone.length} racks`);
                
                if (racksInZone.length === 0) {
                    // Empty zone
                    zoneElement.className = 'zone-slot';
                    const rackInfo = zoneElement.querySelector('.rack-info');
                    if (rackInfo) {
                        rackInfo.innerHTML = '<div class="no-data">Empty</div>';
                    }
                } else {
                    // Occupied zone
                    const rack = racksInZone[0]; // Show first rack if multiple
                    const isMoving = recentlyMovedRacks.has(rack.rack_id);
                    const isTransition = rack.current_camera === 'in_transit';
                    
                    const className = isTransition ? 'zone-slot transition' : 
                                     isMoving ? 'zone-slot moving' : 
                                     'zone-slot occupied';
                    
                    zoneElement.className = className;
                    
                    const rackInfo = zoneElement.querySelector('.rack-info');
                    if (rackInfo) {
                        let rackHtml = `
                            <div class="rack-id">${rack.rack_id.replace('global_rack_', 'R')}</div>
                            <div class="rack-global-id">${rack.rack_id}</div>
                            <div class="rack-status">${isTransition ? 'In Transit' : isMoving ? 'Moving' : 'Stationary'}</div>
                        `;
                        
                        if (racksInZone.length > 1) {
                            rackHtml += `<div class="rack-status">+${racksInZone.length - 1} more</div>`;
                        }
                        
                        rackInfo.innerHTML = rackHtml;
                    }
                    
                    console.log(`Updated zone ${camera}/${zone} with rack ${rack.rack_id} (${isMoving ? 'moving' : 'stationary'})`);
                }
            });
            
            // Update rack count for this camera
            const rackCount = Object.values(racksByCamera[camera]).flat().length;
            const countElement = document.getElementById(`${camera.replace('_', '-')}-rack-count`);
            if (countElement) {
                countElement.textContent = `${rackCount} rack${rackCount !== 1 ? 's' : ''}`;
                console.log(`Updated ${camera} rack count: ${rackCount}`);
            }
        }
        
        // FIXED: Helper function to update global statistics
        function updateGlobalStats(totalRacks, activeRacks, movingRacks, inTransitRacks) {
            const elements = {
                'total-racks': totalRacks,
                'active-racks': activeRacks, 
                'moving-racks': movingRacks,
                'in-transit-racks': inTransitRacks
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`Updated ${id}: ${value}`);
                } else {
                    console.warn(`Element not found: ${id}`);
                }
            });
        }
        
        // FIXED: Helper function to update movement arrows
        function updateMovementArrows(recentMovements) {
            const glToPbMovements = recentMovements.filter(m => 
                m.from_camera === 'general_labor' && m.to_camera === 'powder_booth'
            );
            const pbToGlMovements = recentMovements.filter(m => 
                m.from_camera === 'powder_booth' && m.to_camera === 'general_labor'
            );
            
            const glToPbArrow = document.getElementById('gl-to-pb-arrow');
            const pbToGlArrow = document.getElementById('pb-to-gl-arrow');
            
            if (glToPbArrow) {
                if (glToPbMovements.length > 0) {
                    glToPbArrow.style.display = 'block';
                    glToPbArrow.textContent = `‚Üí Powder Booth (${glToPbMovements.length})`;
                } else {
                    glToPbArrow.style.display = 'none';
                }
            }
            
            if (pbToGlArrow) {
                if (pbToGlMovements.length > 0) {
                    pbToGlArrow.style.display = 'block';
                    pbToGlArrow.textContent = `‚Üê General Labor (${pbToGlMovements.length})`;
                } else {
                    pbToGlArrow.style.display = 'none';
                }
            }
        }
        
        function clearAllZones() {
            document.querySelectorAll('.zone-slot').forEach(slot => {
                slot.className = 'zone-slot';
                const rackInfo = slot.querySelector('.rack-info');
                if (rackInfo) {
                    rackInfo.innerHTML = '<div class="no-data">Empty</div>';
                }
            });
        }
        
        function updateRecentMovements(movements) {
            const movementsList = document.getElementById('recent-movements-list');
            
            if (!movementsList) {
                console.warn('Recent movements list element not found');
                return;
            }
            
            if (!movements || movements.length === 0) {
                movementsList.innerHTML = '<div class="no-data">No recent movements</div>';
                return;
            }
            
            // Show last 5 movements
            const recentMovements = movements.slice(0, 5);
            
            movementsList.innerHTML = recentMovements.map(movement => {
                const timeAgo = getTimeAgo(new Date(movement.movement_timestamp));
                return `
                    <div class="movement-item">
                        <div class="movement-description">
                            <strong>${movement.global_rack_id.replace('global_rack_', 'R')}</strong>: 
                            ${movement.from_camera} ‚Üí ${movement.to_camera}
                        </div>
                        <div class="movement-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        }
        
        function renderGlobalRacksTable(globalRacks) {
            const tbody = document.getElementById('global-racks-body');
            
            if (!tbody) {
                console.warn('Global racks table body not found');
                return;
            }
            
            if (!globalRacks || globalRacks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No global racks found</td></tr>';
                return;
            }
            
            tbody.innerHTML = globalRacks.map(rack => `
                <tr>
                    <td><strong>${rack.rack_id}</strong></td>
                    <td>${rack.current_camera || 'Unknown'}</td>
                    <td>${rack.current_zone || 'N/A'}</td>
                    <td>
                        <span class="action-badge ${rack.status === 'active' ? 'action-hanging' : 'action-removing'}">
                            ${rack.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="timestamp">${formatTimestamp(rack.last_updated)}</td>
                    <td>
                        ${rack.current_camera && rack.current_camera !== 'in_transit' ? `
                            <button class="camera-btn" onclick="showCurrentImage('${rack.current_camera}')">
                                üì∑ View Camera
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function renderBoothStatus(data) {
            const grid = document.getElementById('booth-grid');
            
            if (!data || data.length === 0) {
                grid.innerHTML = '<div class="no-data">No booth data available</div>';
                return;
            }
            
            grid.innerHTML = data.map(booth => `
                <div class="region-card">
                    <button class="review-btn" onclick="showCurrentImage('${booth.region}')">
                        üì∑ Review Current
                    </button>
                    <div class="region-header">
                        <div class="region-name">${booth.region.replace('_', ' ')}</div>
                        <div class="booth-status ${booth.in_use ? 'booth-occupied' : 'booth-empty'}">
                            ${booth.in_use ? 'üî¥ OCCUPIED' : 'üü¢ EMPTY'}
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value">${formatDuration(booth.time_spent_today)}</div>
                            <div class="metric-label">Time Today</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">${booth.person_detected ? 'üë§' : 'üëª'}</div>
                            <div class="metric-label">Person Status</div>
                        </div>
                        ${booth.region === 'sandblast' ? `
                        <div class="metric">
                            <div class="metric-value">${booth.door_closed ? 'üö™üîí' : 'üö™üìñ'}</div>
                            <div class="metric-label">Door Status</div>
                        </div>
                        ` : ''}
                        <div class="metric">
                            <div class="metric-value timestamp">${formatTimestamp(booth.last_updated)}</div>
                            <div class="metric-label">Last Update</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderRackPositions(data) {
            const tbody = document.getElementById('rack-positions-body');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No rack position data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(position => `
                <tr>
                    <td class="timestamp">${formatTimestamp(position.timestamp)}</td>
                    <td>${position.camera_id}</td>
                    <td>${position.rack_id || 'N/A'}</td>
                    <td>${position.global_rack_id || 'N/A'}</td>
                    <td>${position.zone_description || 'N/A'}</td>
                    <td>
                        <div class="moving-indicator ${position.moving ? 'moving-true' : 'moving-false'}">
                            <span class="moving-dot"></span>
                            ${position.moving ? 'Moving' : 'Stationary'}
                        </div>
                    </td>
                    <td>
                        ${position.moving ? `
                            <button class="camera-btn" onclick="showRackBurst('${position.timestamp}', '${position.camera_id}', '${position.rack_id}')">
                                üì∑ Review Burst
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function renderRackEvents(data) {
            const tbody = document.getElementById('rack-events-body');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No rack events data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(event => `
                <tr>
                    <td class="timestamp">${formatTimestamp(event.timestamp)}</td>
                    <td>${event.camera_id}</td>
                    <td>${event.rack_id || 'N/A'}</td>
                    <td>${event.people_count || 0}</td>
                    <td>
                        <span class="action-badge action-${event.action ? event.action.replace(/\s+/g, '-') : 'unknown'}">
                            ${event.action || 'Unknown'}
                        </span>
                    </td>
                    <td>${event.confidence ? (event.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td>${event.zone || 'N/A'}</td>
                    <td>
                        ${event.action && event.action.includes('hanging') ? `
                            <button class="camera-btn" onclick="showHangingBurst('${event.timestamp}', '${event.camera_id}')">
                                üì∑ Review Parts
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function renderHistory(data) {
            const tbody = document.getElementById('history-body');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No history data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(record => `
                <tr>
                    <td class="timestamp">${formatTimestamp(record.timestamp)}</td>
                    <td>${record.region}</td>
                    <td>
                        <span class="booth-status ${record.state === 'OCCUPIED' ? 'booth-occupied' : 'booth-empty'}">
                            ${record.state}
                        </span>
                    </td>
                    <td>${record.duration ? formatDuration(record.duration) : 'N/A'}</td>
                    <td>${record.door_closed !== null ? (record.door_closed ? 'Closed' : 'Open') : 'N/A'}</td>
                    <td>${record.person_detected !== null ? (record.person_detected ? 'Yes' : 'No') : 'N/A'}</td>
                </tr>
            `).join('');
        }
        
        // FIXED: Complete refreshRackData function
        async function refreshRackData() {
            if (refreshInProgress) {
                console.log('Refresh already in progress, skipping...');
                return;
            }
            
            refreshInProgress = true;
            console.log('=== Starting rack data refresh ===');
            
            try {
                updateConnectionStatus('loading', 'üîÑ Loading rack data...');
                
                // Fetch all data in parallel
                console.log('Fetching rack data in parallel...');
                const [globalRacks, movements] = await Promise.all([
                    fetchGlobalRacks(),
                    fetchRackMovements()
                ]);
                
                // Store globally for other functions
                currentGlobalRacks = globalRacks;
                currentMovements = movements;
                
                console.log('Updating rack zone visualization...');
                updateRackZones(globalRacks, movements);
                
                console.log('Updating recent movements display...');
                updateRecentMovements(movements);
                
                console.log('Updating global racks table...');
                renderGlobalRacksTable(globalRacks);
                
                updateConnectionStatus('online', 'üü¢ Online');
                console.log('=== Rack data refresh complete ===');
                
            } catch (error) {
                console.error('Error refreshing rack data:', error);
                updateConnectionStatus('offline', 'üî¥ Error');
                
                // Show error messages in the UI
                const movementsList = document.getElementById('recent-movements-list');
                if (movementsList) {
                    movementsList.innerHTML = `<div class="no-data">Error loading movements: ${error.message}</div>`;
                }
                
                const racksTable = document.getElementById('global-racks-body');
                if (racksTable) {
                    racksTable.innerHTML = `<tr><td colspan="6" class="no-data">Error loading racks: ${error.message}</td></tr>`;
                }
            } finally {
                refreshInProgress = false;
            }
        }
        
        async function fetchData() {
            try {
                updateConnectionStatus('loading', 'üîÑ Loading...');
                
                const [boothData, rackPositions, rackEvents, historyData] = await Promise.all([
                    fetchBoothStatus(),
                    fetchRackPositions(), 
                    fetchRackEvents(),
                    fetchHistory()
                ]);
                
                renderBoothStatus(boothData);
                renderRackPositions(rackPositions);
                renderRackEvents(rackEvents);
                renderHistory(historyData);
                
                updateConnectionStatus('online', 'üü¢ Online');
                
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus('offline', 'üî¥ Offline');
                
                const errorMsg = `<tr><td colspan="8" class="no-data">Error loading data: ${error.message}</td></tr>`;
                document.getElementById('rack-positions-body').innerHTML = errorMsg;
                document.getElementById('rack-events-body').innerHTML = errorMsg;
                document.getElementById('history-body').innerHTML = errorMsg;
                
                document.getElementById('booth-grid').innerHTML = 
                    `<div class="no-data">Error loading booth data: ${error.message}</div>`;
            }
        }
        
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = text;
            }
            
            if (status === 'online') {
                const lastUpdateElement = document.getElementById('last-update');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = `Last Update: ${new Date().toLocaleTimeString()}`;
                }
            }
        }
        
        function refreshData() {
            fetchData();
            // Also refresh rack data if on rack tracking tab
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.textContent.includes('Rack Tracking')) {
                refreshRackData();
            }
        }
        
        // Enhanced auto-refresh setup
        function setupAutoRefresh() {
            // Refresh main data every 30 seconds
            setInterval(() => {
                if (!refreshInProgress) {
                    console.log('Auto-refreshing main data...');
                    fetchData();
                }
            }, 30000);
            
            // Refresh rack data every 15 seconds when on rack tracking tab
            setInterval(() => {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.textContent.includes('Rack Tracking')) {
                    if (!refreshInProgress) {
                        console.log('Auto-refreshing rack data...');
                        refreshRackData();
                    }
                }
            }, 15000);
        }
        
        // Modal functionality and initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            
            const modal = document.getElementById('imageModal');
            const closeBtn = document.querySelector('.close');
            
            if (closeBtn) {
                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                }
            }
            
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
            
            // Setup filter change handlers for rack tracking
            const statusFilter = document.getElementById('rack-status-filter');
            const cameraFilter = document.getElementById('camera-filter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    console.log('Status filter changed to:', this.value);
                    // TODO: Implement filtering logic
                });
            }
            
            if (cameraFilter) {
                cameraFilter.addEventListener('change', function() {
                    console.log('Camera filter changed to:', this.value);
                    // TODO: Implement filtering logic
                });
            }
            
            // Setup auto-refresh
            setupAutoRefresh();
            
            // Initial data load
            fetchData();
            
            // If rack tracking tab is initially active, load rack data
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.textContent.includes('Rack Tracking')) {
                setTimeout(() => {
                    console.log('Initial rack data load for active tab');
                    refreshRackData();
                }, 500);
            }
        });
    </script>
</body>
</html>